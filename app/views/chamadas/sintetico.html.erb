<div class="page-header">
  <h1>Relatório versão Sintética</h1>
</div>

<form action="/chamadas/sintetico" method="get" class="busca">
  <div style="clear:both">
    <label>Login ou telefone:</label>
    <input type="text" class="form-control" name="q" value="<%= params[:q] %>">
    <br>
    <br>
    <label>Data de:</label>
    <input type="date" style="width: 180px" class="form-control" name="data_de" value="<%= params[:data_de] %>">
    <label>Data até:</label>
    <input type="date" style="width: 180px" class="form-control" name="data_ate" value="<%= params[:data_ate] %>">
    <br>
    <label>Duração de:</label>
    <% time = Time.parse("00:00:00") %>
    <select class="form-control"  name="duracao_de" style="width: 180px"  >
      <option value="">[Selecione]</option>
      <% while time < Time.parse("01:00:15") %>
        <option value="<%= time.strftime("%H:%M:%S") %>" <% if params[:duracao_de] == time.strftime("%H:%M:%S") %>selected<% end %>><%= time.strftime("%H:%M:%S") %></option>
        <% time = time + 15.seconds %>
      <% end %>
    </select>

    <label>Duração até:</label>
    <% time = Time.parse("00:00:00") %>
    <select class="form-control"  name="duracao_ate" style="width: 180px"  >
      <option value="">[Selecione]</option>
      <% while time < Time.parse("01:00:15") %>
        <option value="<%= time.strftime("%H:%M:%S") %>" <% if params[:duracao_ate] == time.strftime("%H:%M:%S") %>selected<% end %>><%= time.strftime("%H:%M:%S") %></option>
        <% time = time + 15.seconds %>
      <% end %>
    </select>
    <br>
    <input type="submit" value="Buscar" class="btn btn-primary">
  </div>
</form>
<hr>

<div class="table-responsive">
  <table class="table table-striped table-bordered table-hover" style="width: 100%">
    <thead>
      <tr style="background-color: #cfcfcf;">
        <th colspan="100%" style="text-align: center;">Relatório sintético de Ligações Rimaq - Por Volume (Feita)</th>
      </tr>
    </thead>

    <% 
    todos_status = []
    @chamadas.pluck(:destino_status).uniq.compact.each do |status|
      todos_status << status if status.present?
    end

    todos_login = []
    @chamadas.pluck(:login).uniq.compact.each do |login|
      todos_login << login if login.present?
    end
    %>
    <thead>
      <tr>
        <th></th>
        <% todos_status.each do |status| %>
          <th><%= status.upcase %></th>
        <% end %>
        <th>TOTAL</th>
      </tr>
    </thead>

    <tbody>
      <% todos_login.each do |login| %>
      <tr>
        <td><%= login %></td>
        <% todos_status.each do |status| %>
          <td>
            <%= @chamadas.where(login: login).where(destino_status: status).count %>
          </td>
        <% end %>
        <td>
          <%= @chamadas.where(login: login).where(destino_status: todos_status).count %>
        </td>
      </tr>
      <% end %>
      <tr style="background-color: #bebee8">
        <td>TOTAL</td>
        <% todos_status.each do |status| %>
          <td>
            <%= @chamadas.where(login: todos_login).where(destino_status: status).count %>
          </td>
        <% end %>
        <td>
          <%= @chamadas.where(login: todos_login).where(destino_status: todos_status).count %>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<div class="table-responsive">
  <table class="table table-striped table-bordered table-hover" style="width: 100%">
    <thead>
      <tr style="background-color: #cfcfcf;">
        <th colspan="100%" style="text-align: center;">Relatório sintético de Ligações Rimaq - Por Duração (Feita)</th>
      </tr>
    </thead>

    <% 
    todos_status = []
    @chamadas.pluck(:destino_status).uniq.compact.each do |status|
      todos_status << status if status.present?
    end

    todos_login = []
    @chamadas.pluck(:login).uniq.compact.each do |login|
      todos_login << login if login.present?
    end
    %>
    <thead>
      <tr>
        <th></th>
        <% todos_status.each do |status| %>
          <th><%= status.upcase %></th>
        <% end %>
        <th>TOTAL</th>
      </tr>
    </thead>

    <tbody>
      <% todos_login.each do |login| %>
      <tr>
        <td><%= login %></td>
        <% todos_status.each do |status| %>
          <td>
            <% valor = @chamadas.where(login: login).where(destino_status: status).sum(:destino_duracao_cobrada) %>
            <%= valor == "0" ? "00:00:00" : valor %>
          </td>
        <% end %>
        <td>
          <% valor = @chamadas.where(login: login).where(destino_status: todos_status).sum(:destino_duracao_cobrada) %>
          <%= valor == "0" ? "00:00:00" : valor %>
        </td>
      </tr>
      <% end %>
      <tr style="background-color: #bebee8">
        <td>TOTAL</td>
        <% todos_status.each do |status| %>
          <td>
            <% valor = @chamadas.where(login: todos_login).where(destino_status: status).sum(:destino_duracao_cobrada) %>
            <%= valor == "0" ? "00:00:00" : valor %>
          </td>
        <% end %>
        <td>
          <% valor = @chamadas.where(login: todos_login).where(destino_status: todos_status).sum(:destino_duracao_cobrada) %>
          <%= valor == "0" ? "00:00:00" : valor %>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<hr>

<div class="table-responsive">
  <table class="table table-striped table-bordered table-hover" style="width: 100%">
    <thead>
      <tr style="background-color: #cfcfcf;">
        <th colspan="100%" style="text-align: center;">Relatório sintético de Ligações Rimaq - Por Volume (Recebida)</th>
      </tr>
    </thead>

    <% 
    todos_status = []
    @chamadas.pluck(:origem_status).uniq.compact.each do |status|
      todos_status << status if status.present?
    end

    todos_login = []
    @chamadas.pluck(:login).uniq.compact.each do |login|
      todos_login << login if login.present?
    end
    %>
    <thead>
      <tr>
        <th></th>
        <% todos_status.each do |status| %>
          <th><%= status.upcase %></th>
        <% end %>
        <th>TOTAL</th>
      </tr>
    </thead>

    <tbody>
      <% todos_login.each do |login| %>
      <tr>
        <td><%= login %></td>
        <% todos_status.each do |status| %>
          <td>
            <%= @chamadas.where(login: login).where(origem_status: status).count %>
          </td>
        <% end %>
        <td>
          <%= @chamadas.where(login: login).where(origem_status: todos_status).count %>
        </td>
      </tr>
      <% end %>
      <tr style="background-color: #bebee8">
        <td>TOTAL</td>
        <% todos_status.each do |status| %>
          <td>
            <%= @chamadas.where(login: todos_login).where(origem_status: status).count %>
          </td>
        <% end %>
        <td>
          <%= @chamadas.where(login: todos_login).where(origem_status: todos_status).count %>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<div class="table-responsive">
  <table class="table table-striped table-bordered table-hover" style="width: 100%">
    <thead>
      <tr style="background-color: #cfcfcf;">
        <th colspan="100%" style="text-align: center;">Relatório sintético de Ligações Rimaq - Por Duração (Recebida)</th>
      </tr>
    </thead>

    <% 
    todos_status = []
    @chamadas.pluck(:origem_status).uniq.compact.each do |status|
      todos_status << status if status.present?
    end

    todos_login = []
    @chamadas.pluck(:login).uniq.compact.each do |login|
      todos_login << login if login.present?
    end
    %>
    <thead>
      <tr>
        <th></th>
        <% todos_status.each do |status| %>
          <th><%= status.upcase %></th>
        <% end %>
        <th>TOTAL</th>
      </tr>
    </thead>

    <tbody>
      <% todos_login.each do |login| %>
      <tr>
        <td><%= login %></td>
        <% todos_status.each do |status| %>
          <td>
            <% valor = @chamadas.where(login: login).where(origem_status: status).sum(:origem_duracao_cobrada) %>
            <%= valor == "0" ? "00:00:00" : valor %>
          </td>
        <% end %>
        <td>
          <% valor = @chamadas.where(login: login).where(origem_status: todos_status).sum(:origem_duracao_cobrada) %>
          <%= valor == "0" ? "00:00:00" : valor %>
        </td>
      </tr>
      <% end %>
      <tr style="background-color: #bebee8">
        <td>TOTAL</td>
        <% todos_status.each do |status| %>
          <td>
            <% valor = @chamadas.where(login: todos_login).where(origem_status: status).sum(:origem_duracao_cobrada) %>
            <%= valor == "0" ? "00:00:00" : valor %>
          </td>
        <% end %>
        <td>
          <% valor = @chamadas.where(login: todos_login).where(origem_status: todos_status).sum(:origem_duracao_cobrada) %>
          <%= valor == "0" ? "00:00:00" : valor %>
        </td>
      </tr>
    </tbody>
  </table>
</div>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
